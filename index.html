<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deus Create Fix</title>
<style>
body{margin:0;background:#111;color:#fff;font-family:sans-serif;overflow-x:hidden}
#app{display:grid;grid-template-rows:auto auto auto auto 1fr;gap:6px;padding:6px;height:100vh;box-sizing:border-box}
.row{display:grid;gap:6px}
.top{grid-template-columns:1fr 1fr}
.mid{grid-template-columns:1fr 1fr}
.bottom{grid-template-columns:1fr 1fr}
.box{background:#1e1e3a;border:1px solid #444;border-radius:6px;padding:6px;font-size:12px}
.title{font-weight:bold;margin-bottom:4px}
.market,.deus{display:flex;flex-direction:column;gap:4px}
.card{background:#2b2b55;border:1px solid #666;border-radius:6px;padding:4px;font-size:11px}
.highlight{border:2px solid #0ff;box-shadow:0 0 10px #0ff;background:#333366}
button{font-size:10px;margin-top:2px;padding:2px 4px;border:none;border-radius:4px;background:#4444aa;color:#fff}
button:disabled{opacity:.3}
.scroll{overflow-y:auto;overflow-x:hidden}
.fixed{height:120px}
.log{height:130px;overflow-y:auto;overflow-x:hidden}
.turn{text-align:center;font-weight:bold}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:1000}
.popup{background:#222;padding:16px;border-radius:8px;min-width:200px;text-align:center}
.popup-item{margin:6px 0;padding:6px;border:1px solid #555;border-radius:6px}
.popup-item.active{border:2px solid #0ff;box-shadow:0 0 8px #0ff;cursor:pointer}
</style>
</head>
<body>
<div id="app"></div>
<script>
const state={
 currentPlayer:"player",
 isGameOver:false,
 isResolvingEnhance:false,
 pendingEnhance:0,
 enhanceIndex:null,
 players:{player:null,bot:null},
 deck:[],
 market:[],
 deus:[],
 log:[],
 botScheduled:false,
 turnLock:false
};

function icon(c){return c==="yellow"?"ğŸŸ¡":c==="green"?"ğŸŸ¢":c==="blue"?"ğŸ”µ":"ğŸŸ£"}
function capMoney(v){return Math.min(10,Math.max(0,v))}

function createPlayer(){
 return{money:5,crystals:{yellow:0,green:0,blue:0,purple:0},hand:[],used:[],deusCount:0,score:0}
}

const ALL_CARDS=[
 {name:"ğŸŸ¡2",type:"gain",g:{yellow:2},r:2},
 {name:"ğŸŸ¢1",type:"gain",g:{green:1},r:2},
 {name:"ğŸ”µ1",type:"gain",g:{blue:1},r:3},
 {name:"ğŸŸ£1",type:"gain",g:{purple:1},r:4},
 {name:"ğŸ”º1",type:"enhance",u:1,r:3},
 {name:"ğŸŸ¡1â†’ğŸŸ¢1",type:"exchange",from:{yellow:1},to:{green:1},r:2}
];

function buildDeck(){
 state.deck=[];
 ALL_CARDS.forEach(c=>{
  for(let i=0;i<3;i++) state.deck.push(JSON.parse(JSON.stringify(c)));
 });
}

function drawMarket(){
 while(state.market.length<5 && state.deck.length>0){
  const idx=Math.floor(Math.random()*state.deck.length);
  state.market.push(state.deck.splice(idx,1)[0]);
 }
}

function generateDeus(){
 const score=Math.floor(Math.random()*13)+8;
 while(true){
  const total=Math.floor(Math.random()*4)+3;
  const n={yellow:0,green:0,blue:0,purple:0};
  for(let i=0;i<total;i++){
   const keys=["yellow","green","blue","purple"];
   n[keys[Math.floor(Math.random()*4)]]++;
  }
  const v=n.yellow+2*n.green+3*n.blue+4*n.purple;
  if(v===score)return{need:n,score};
 }
}

function init(){
 state.players.player=createPlayer();
 state.players.bot=createPlayer();
 state.players.player.hand.push({name:"ğŸŸ¡2",type:"gain",g:{yellow:2},r:0});
 state.players.player.hand.push({name:"ğŸ”º1",type:"enhance",u:1,r:0});
 state.players.bot.hand.push({name:"ğŸŸ¡2",type:"gain",g:{yellow:2},r:0});
 state.players.bot.hand.push({name:"ğŸ”º1",type:"enhance",u:1,r:0});
 buildDeck();
 drawMarket();
 for(let i=0;i<5;i++) state.deus.push(generateDeus());
 render();
}

function addLog(t){state.log.unshift(t)}

function endTurn(){
 if(state.isGameOver||state.turnLock)return;
 state.turnLock=true;
 state.currentPlayer=state.currentPlayer==="player"?"bot":"player";
 render();
 state.turnLock=false;
 if(state.currentPlayer==="bot"&&!state.botScheduled&&!state.isGameOver){
  state.botScheduled=true;
  setTimeout(()=>{state.botScheduled=false;botTurn()},300);
 }
}

function perform(fn){
 try{
  fn();
  render();
  checkWin();
  if(!state.isResolvingEnhance) endTurn();
 }catch(e){endTurn();}
}

function canCreate(player,deus){
 for(let k in deus.need){
  if(player.crystals[k] < deus.need[k]) return false;
 }
 return true;
}

function createDeusPlayer(i){
 if(state.currentPlayer!=="player"||state.isGameOver||state.isResolvingEnhance)return;
 const p=state.players.player;
 const d=state.deus[i];
 if(!canCreate(p,d)) return;
 perform(()=>{
  for(let k in d.need){
   p.crystals[k]-=d.need[k];
  }
  p.score+=d.score;
  p.deusCount+=1;
  addLog("ã€PLAYERã€‘ğŸ’ "+d.score+" ã®ãƒ‡ã‚¦ã‚¹ã‚’ä½œæˆ");
  state.deus[i]=generateDeus();
 });
}

function createDeusBot(){
 const p=state.players.bot;
 for(let i=0;i<state.deus.length;i++){
  const d=state.deus[i];
  if(canCreate(p,d)){
   for(let k in d.need){
    p.crystals[k]-=d.need[k];
   }
   p.score+=d.score;
   p.deusCount+=1;
   addLog("ã€BOTã€‘ğŸ’ "+d.score+" ã®ãƒ‡ã‚¦ã‚¹ã‚’ä½œæˆ");
   state.deus[i]=generateDeus();
   return true;
  }
 }
 return false;
}

function buy(i){
 if(state.currentPlayer!=="player"||state.isGameOver||state.isResolvingEnhance)return;
 const p=state.players.player;
 const c=state.market[i];
 if(p.money>=c.r){
  perform(()=>{
   p.money=capMoney(p.money-c.r);
   p.hand.push(c);
   state.market.splice(i,1);
   drawMarket();
   addLog("ã€PLAYERã€‘"+c.name+" ã‚’è³¼å…¥");
  });
 }
}

function use(i){
 if(state.currentPlayer!=="player"||state.isGameOver||state.isResolvingEnhance)return;
 const p=state.players.player;
 const c=p.hand[i];

 const usable =
  (c.type==="gain") ||
  (c.type==="exchange" && p.crystals.yellow>=1) ||
  (c.type==="enhance" && (p.crystals.yellow>0||p.crystals.green>0||p.crystals.blue>0));

 if(!usable)return;

 if(c.type==="gain"){
  perform(()=>{
   for(let k in c.g)p.crystals[k]+=c.g[k];
   p.money=capMoney(p.money+2);
   p.used.push(c);
   p.hand.splice(i,1);
   addLog("ã€PLAYERã€‘"+c.name+" ã‚’ä½¿ç”¨");
  });
 }

 if(c.type==="exchange"){
  perform(()=>{
   p.crystals.yellow-=1;
   p.crystals.green+=1;
   p.money=capMoney(p.money+2);
   p.used.push(c);
   p.hand.splice(i,1);
   addLog("ã€PLAYERã€‘"+c.name+" ã‚’ä½¿ç”¨");
  });
 }

 if(c.type==="enhance"){
  state.isResolvingEnhance=true;
  state.pendingEnhance=c.u;
  state.enhanceIndex=i;
  render();
 }
}

function enhance(color){
 if(!state.isResolvingEnhance)return;
 const p=state.players.player;
 const next=color==="yellow"?"green":color==="green"?"blue":"purple";
 if(color==="purple")return;
 if(p.crystals[color]>0){
  p.crystals[color]--;
  p.crystals[next]++;
  addLog("ã€PLAYERã€‘ğŸ”º1 â†’ "+icon(color)+"â†’"+icon(next));
  state.pendingEnhance--;
  if(state.pendingEnhance===0){
   const card=p.hand[state.enhanceIndex];
   p.money=capMoney(p.money+2);
   p.used.push(card);
   p.hand.splice(state.enhanceIndex,1);
   state.isResolvingEnhance=false;
   render();
   checkWin();
   endTurn();
  }else render();
 }
}

function restPlayer(){
 if(state.currentPlayer!=="player"||state.isGameOver||state.isResolvingEnhance)return;
 const p=state.players.player;
 if(p.used.length>0){
  perform(()=>{
   const n=p.used.length;
   p.hand=p.hand.concat(p.used);
   p.used=[];
   addLog("ã€PLAYERã€‘ä¼‘ã‚€ï¼ˆä½¿ç”¨æ¸ˆã¿"+n+"æšå›åï¼‰");
  });
 }
}

function botTurn(){
 if(state.isGameOver)return;
 const p=state.players.bot;
 if(createDeusBot()){
  render();
  checkWin();
  endTurn();
  return;
 }
 for(let i=0;i<p.hand.length;i++){
  const c=p.hand[i];
  if(c.type==="gain"){
   for(let k in c.g)p.crystals[k]+=c.g[k];
   p.money=capMoney(p.money+2);
   p.used.push(c);
   p.hand.splice(i,1);
   addLog("ã€BOTã€‘"+c.name+" ã‚’ä½¿ç”¨");
   render();
   checkWin();
   endTurn();
   return;
  }
 }
 endTurn();
}

function checkWin(){
 if(state.players.player.deusCount>=5||state.players.bot.deusCount>=5){
  state.isGameOver=true;
 }
}

function render(){
 let html="";
 html+="<div class='row top'>";
 ["player","bot"].forEach(name=>{
  const p=state.players[name];
  html+="<div class='box'><div class='title'>"+name.toUpperCase()+"</div>";
  html+="ğŸ’°"+p.money+" ğŸ’ "+p.score+"<br>";
  html+="ä½œæˆæ•° : "+p.deusCount+"<br>";
  html+="ğŸŸ¡"+p.crystals.yellow+" ğŸŸ¢"+p.crystals.green+" ğŸ”µ"+p.crystals.blue+" ğŸŸ£"+p.crystals.purple;
  html+="</div>";
 });
 html+="</div>";

 html+="<div class='row mid'>";
 html+="<div class='box'><div class='title'>å¸‚å ´</div><div class='market'>";
 state.market.forEach((c,i)=>{
  const can=state.currentPlayer==="player"&&state.players.player.money>=c.r&&!state.isResolvingEnhance;
  html+="<div class='card "+(can?"highlight":"")+"'>";
  html+=c.name+"<br>ğŸ’°"+c.r+"<br>";
  html+="<button "+(can?"":"disabled")+" onclick='buy("+i+")'>è³¼å…¥</button>";
  html+="</div>";
 });
 html+="</div></div>";

 html+="<div class='box'><div class='title'>ãƒ‡ã‚¦ã‚¹</div><div class='deus'>";
 state.deus.forEach((d,i)=>{
  const can=state.currentPlayer==="player"&&!state.isResolvingEnhance&&canCreate(state.players.player,d);
  html+="<div class='card "+(can?"highlight":"")+"'>";
  html+="ğŸ’ "+d.score+"<br>";
  html+=Object.entries(d.need).filter(([k,v])=>v>0).map(([k,v])=>icon(k)+v).join(" ");
  html+="<br><button "+(can?"":"disabled")+" onclick='createDeusPlayer("+i+")'>ä½œæˆ</button>";
  html+="</div>";
 });
 html+="</div></div></div>";

 html+="<div class='row bottom'>";
 html+="<div class='box scroll fixed'><div class='title'>æ‰‹æœ­</div>";
 state.players.player.hand.forEach((c,i)=>{
  html+="<div class='card'>"+c.name+"<br><button onclick='use("+i+")'>ä½¿ç”¨</button></div>";
 });
 html+="</div>";

 html+="<div class='box scroll fixed'><div class='title'>ä½¿ç”¨æ¸ˆã¿</div>";
 state.players.player.used.forEach(c=>{
  html+="<div class='card'>"+c.name+"</div>";
 });
 html+="<button onclick='restPlayer()'>ä¼‘ã‚€</button>";
 html+="</div></div>";

 html+="<div class='box log'><div class='title'>ãƒ­ã‚°</div>";
 html+=state.log.map(l=>"<div>"+l+"</div>").join("");
 html+="</div>";

 html+="<div class='turn'>ç¾åœ¨ã‚¿ãƒ¼ãƒ³ï¼š"+state.currentPlayer+"</div>";

 if(state.isResolvingEnhance){
  const p=state.players.player;
  html+="<div class='overlay'><div class='popup'>";
  html+="<div>å¼·åŒ– æ®‹:"+state.pendingEnhance+"</div>";
  ["yellow","green","blue","purple"].forEach(c=>{
   const count=p.crystals[c];
   const selectable = c!=="purple" && count>0;
   html+="<div class='popup-item "+(selectable?"active":"")+"' ";
   if(selectable) html+="onclick=\"enhance('"+c+"')\"";
   html+=">"+icon(c)+" Ã—"+count+"</div>";
  });
  html+="</div></div>";
 }

 document.getElementById("app").innerHTML=html;
}

init();
</script>
</body>
</html>
